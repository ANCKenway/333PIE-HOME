<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>333HOME - Domotique Pro v7.1</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js avec plugin Collapse -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak]{display:none!important}
        *{scrollbar-width:thin;scrollbar-color:rgba(156,163,175,0.5) transparent}
        *::-webkit-scrollbar{width:6px;height:6px}
        *::-webkit-scrollbar-track{background:transparent}
        *::-webkit-scrollbar-thumb{background:rgba(156,163,175,0.5);border-radius:3px}
        *::-webkit-scrollbar-thumb:hover{background:rgba(107,114,128,0.7)}
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased" x-data="app()" x-init="init()">
    
    <!-- Navigation Top Bar -->
    <nav class="bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-2xl">üè†</div>
                    <div>
                        <h1 class="text-xl font-bold">333HOME</h1>
                        <p class="text-xs text-purple-200">Domotique Pro v7.0</p>
                    </div>
                </div>
                
                <div class="hidden md:flex space-x-1">
                    <template x-for="t in tabs" :key="t.id">
                        <button @click="tab=t.id" :class="tab===t.id?'bg-white/20 font-semibold':'hover:bg-white/10'" class="px-4 py-2 rounded-lg transition-all text-sm flex items-center space-x-2">
                            <span x-text="t.icon"></span>
                            <span x-text="t.name"></span>
                        </button>
                    </template>
                </div>
                
                <div class="flex items-center space-x-3">
                    <span class="hidden sm:flex items-center space-x-2 bg-white/20 px-3 py-1 rounded-full text-sm">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span x-text="stats.online+' online'"></span>
                    </span>
                    <button @click="refreshAll()" class="p-2 hover:bg-white/10 rounded-lg transition-all" title="Actualiser">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div class="md:hidden border-t border-white/10">
            <div class="flex overflow-x-auto px-2 py-2 space-x-1">
                <template x-for="t in tabs" :key="t.id">
                    <button @click="tab=t.id" :class="tab===t.id?'bg-white/20 font-semibold':'hover:bg-white/10'" class="px-3 py-1 rounded-lg whitespace-nowrap text-sm flex items-center space-x-1">
                        <span x-text="t.icon"></span>
                        <span x-text="t.name"></span>
                    </button>
                </template>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- TAB: Dashboard -->
        <div x-show="tab==='dashboard'" x-cloak class="space-y-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">üìä Dashboard</h2>
                    <p class="text-sm text-gray-600">Vue d'ensemble du syst√®me ‚Ä¢ <span x-text="lastUpdate"></span></p>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Total Devices</p>
                            <p class="text-3xl font-bold text-gray-900" x-text="stats.total||0"></p>
                        </div>
                        <div class="text-4xl">üì±</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">En Ligne</p>
                            <p class="text-3xl font-bold text-green-600" x-text="stats.online||0"></p>
                        </div>
                        <div class="text-4xl">‚úÖ</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-red-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Hors Ligne</p>
                            <p class="text-3xl font-bold text-red-600" x-text="stats.offline||0"></p>
                        </div>
                        <div class="text-4xl">‚ùå</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">G√©r√©s</p>
                            <p class="text-3xl font-bold text-blue-600" x-text="stats.managed||0"></p>
                        </div>
                        <div class="text-4xl">üéØ</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- System Health -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üè† √âtat Syst√®me</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                            <span class="text-sm font-medium text-gray-700">Serveur 333HOME</span>
                            <span class="px-3 py-1 bg-green-600 text-white rounded-full text-xs font-semibold">‚úÖ Online</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Version</span>
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">v3.0.0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Backend API</span>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">‚úÖ OK</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Base de donn√©es</span>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">‚úÖ OK</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö° Actions Rapides</h3>
                    <div class="space-y-3">
                        <button @click="tab='scanner'" class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 border border-green-200 rounded-lg transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">üîç</span>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900">Scanner R√©seau</p>
                                    <p class="text-xs text-gray-600">D√©couvrir les appareils</p>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <button @click="tab='managed'" class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 border border-purple-200 rounded-lg transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">üì±</span>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900">G√©rer Appareils</p>
                                    <p class="text-xs text-gray-600" x-text="stats.managed+' appareil(s) g√©r√©(s)'"></p>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <button @click="exportAllData()" class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 border border-blue-200 rounded-lg transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">üì•</span>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900">Exporter Donn√©es</p>
                                    <p class="text-xs text-gray-600">Backup JSON complet</p>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB: Managed Devices -->
        <div x-show="tab==='managed'" x-cloak class="space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">üì± Appareils G√©r√©s</h2>
                    <p class="text-sm text-gray-600"><span x-text="managedDevices().length"></span> appareil(s) sous gestion</p>
                </div>
                <div class="flex gap-2">
                    <button @click="showAddModal=true" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all flex items-center space-x-2">
                        <span>‚ûï</span>
                        <span>Ajouter</span>
                    </button>
                    <button @click="loadDevices()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span>Actualiser</span>
                    </button>
                </div>
            </div>
            
            <div x-show="loading" class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-600 border-t-transparent"></div>
                <p class="mt-4 text-gray-600">Chargement...</p>
            </div>
            
            <div x-show="!loading && managedDevices().length===0" class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                <div class="text-6xl mb-4">üì±</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun appareil g√©r√©</h3>
                <p class="text-gray-600 mb-6">Scannez votre r√©seau pour d√©couvrir des appareils ou ajoutez-en manuellement</p>
                <div class="flex gap-3 justify-center">
                    <button @click="tab='scanner'" class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all font-semibold">
                        üåê Scanner le R√©seau
                    </button>
                    <button @click="showAddModal=true" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg transition-all font-semibold">
                        ‚ûï Ajouter Manuellement
                    </button>
                </div>
            </div>
            
            <div x-show="!loading && managedDevices().length>0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="d in managedDevices()" :key="d.ip||d.current_ip">
                    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-200 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-semibold text-gray-900" x-text="getDeviceTitle(d)"></h3>
                                    <span x-show="d.vpn_ip" :class="d.is_vpn_connected ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-300 text-gray-600'" class="px-2 py-1 rounded-full text-xs font-semibold">üîí VPN</span>
                                </div>
                                <p class="text-sm text-gray-600 font-mono" x-text="d.ip||d.current_ip"></p>
                                <p x-show="d.is_vpn_connected && d.vpn_ip" class="text-xs text-emerald-600 font-mono" x-text="'VPN: '+d.vpn_ip"></p>
                            </div>
                            <span :class="(d.status==='online'||d.currently_online)?'bg-green-100 text-green-800':'bg-red-100 text-red-800'" class="px-2 py-1 rounded-full text-xs font-semibold" x-text="(d.status==='online'||d.currently_online)?'‚úÖ':'‚ùå'"></span>
                        </div>
                        
                        <div class="space-y-2 mb-4 text-xs">
                            <div x-show="d.mac" class="flex justify-between">
                                <span class="text-gray-600">MAC:</span>
                                <span class="text-gray-900 font-mono text-xs" x-text="d.mac"></span>
                            </div>
                            <div x-show="d.type||d.device_type" class="flex justify-between">
                                <span class="text-gray-600">Type:</span>
                                <span class="text-gray-900" x-text="d.type||d.device_type"></span>
                            </div>
                            <div x-show="d.manufacturer||d.vendor" class="flex justify-between">
                                <span class="text-gray-600">Fabricant:</span>
                                <span class="text-gray-900" x-text="d.manufacturer||d.vendor"></span>
                            </div>
                            <div x-show="d.last_seen" class="flex justify-between">
                                <span class="text-gray-600">Vu:</span>
                                <span class="text-gray-900" x-text="formatTime(d.last_seen)"></span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="wakeDevice(d)" x-show="d.mac && !(d.status==='online'||d.currently_online)" class="px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg text-sm font-medium transition-all" title="Wake-on-LAN">‚ö°</button>
                            <button @click="viewHistory(d)" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm font-medium transition-all" title="Historique">üìä</button>
                            <button @click="removeDevice(d)" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg text-sm font-medium transition-all" title="Retirer">üóëÔ∏è</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- TAB: Scanner -->
        <div x-show="tab==='network'" x-cloak class="space-y-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">üåê R√©seau Local</h2>
                    <p class="text-sm text-gray-600">Vue d'ensemble et cartographie du r√©seau</p>
                </div>
                <button @click="showScanPanel=!showScanPanel" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg transition-all text-sm font-medium flex items-center space-x-2">
                    <span>üîç</span>
                    <span x-text="showScanPanel?'Masquer scan':'Nouveau scan'"></span>
                </button>
            </div>
            
            <!-- Panel Scan (masqu√© par d√©faut) -->
            <div x-show="showScanPanel" x-collapse class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Scanner le r√©seau</h3>
                <div class="max-w-md mx-auto">
                    <button @click="startScan('full')" :disabled="scanning" class="w-full p-6 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 rounded-xl border-2 border-purple-200 text-left transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md">
                        <div class="flex items-start justify-between mb-3">
                            <div class="text-4xl">üîç</div>
                            <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-xs font-semibold">Scan Complet</span>
                        </div>
                        <h4 class="font-bold text-gray-900 mb-2">Enrichir le monitoring r√©seau</h4>
                        <ul class="text-sm text-gray-600 space-y-1 mb-3">
                            <li>‚úÖ D√©tection multi-sources (nmap + ARP + mDNS + NetBIOS)</li>
                            <li>‚úÖ Vendor, OS, services d√©taill√©s</li>
                            <li>‚úÖ Enrichissement du registry (historique IP/hostname)</li>
                            <li>‚úÖ D√©tection changements DHCP</li>
                            <li>‚è±Ô∏è Dur√©e: ~15-20 secondes</li>
                        </ul>
                        <p class="text-xs text-purple-600 font-medium">üíæ Les donn√©es enrichissent le suivi persistant des devices</p>
                    </button>
                </div>
            </div>
            
            <div x-show="scanning" class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-purple-600 border-t-transparent mb-4"></div>
                <p class="text-xl font-semibold text-gray-900 mb-2">Scan en cours...</p>
                <p class="text-gray-600 mb-4" x-text="'Type: '+scanType+' ‚Ä¢ Merci de patienter'"></p>
                <div class="max-w-md mx-auto bg-gray-200 rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full animate-pulse" style="width:75%"></div>
                </div>
            </div>
            
            <div x-show="!scanning && scanResults.length>0" class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">R√©sultats du scan</h3>
                        <p class="text-sm text-gray-600"><span x-text="scanResults.length"></span> appareil(s) d√©tect√©(s) ‚Ä¢ Type: <span x-text="scanType"></span></p>
                    </div>
                    <button @click="scanResults=[]" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all text-sm font-medium">
                        üóëÔ∏è Effacer
                    </button>
                </div>
                <div class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                    <template x-for="(d,i) in scanResults" :key="i">
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 space-y-2">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-baseline gap-2">
                                            <h4 class="font-semibold text-gray-900" x-text="getDeviceTitle(d)"></h4>
                                            <span x-show="d.current_hostname" class="text-xs text-gray-500" x-text="'('+d.current_ip+')'"></span>
                                        </div>
                                        <span :class="d.currently_online?'bg-green-100 text-green-800':'bg-red-100 text-red-800'" class="px-2 py-1 rounded-full text-xs font-semibold" x-text="d.currently_online?'‚úÖ':'‚ùå'"></span>
                                        <span x-show="d.vpn_ip" :class="d.is_vpn_connected ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-300 text-gray-600'" class="px-2 py-1 rounded-full text-xs font-semibold">üîí VPN</span>
                                        <span x-show="d.in_devices" class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">‚úì G√©r√©</span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-sm">
                                        <div x-show="!d.current_hostname"><span class="text-gray-600">IP:</span> <span class="font-mono text-gray-900" x-text="d.current_ip||d.ip||'N/A'"></span></div>
                                        <div><span class="text-gray-600">MAC:</span> <span class="font-mono text-xs text-gray-900" x-text="d.mac||'N/A'"></span></div>
                                        <div x-show="d.vendor && d.vendor!=='Unknown'"><span class="text-gray-600">Fabricant:</span> <span class="text-gray-900" x-text="d.vendor"></span></div>
                                        <div x-show="d.os_detected && d.os_detected!=='Unknown'"><span class="text-gray-600">OS:</span> <span class="text-gray-900" x-text="d.os_detected"></span></div>
                                        <div x-show="d.is_vpn_connected && d.vpn_ip"><span class="text-gray-600">IP VPN:</span> <span class="font-mono text-emerald-700 font-medium" x-text="d.vpn_ip"></span></div>
                                        <div x-show="d.services && Array.isArray(d.services) && d.services.length>0" class="col-span-full"><span class="text-gray-600">Services:</span> <span class="text-purple-600 font-medium" x-text="(d.services||[]).map(s=>s.port+'/'+s.service).join(' ‚Ä¢ ')"></span></div>
                                    </div>
                                </div>
                                <button x-show="!d.in_devices" @click="addDeviceToManaged(d)" class="ml-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                                    ‚ûï G√©rer
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div x-show="!scanning && scanResults.length===0" class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                <div class="text-6xl mb-4">üåê</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun scan effectu√©</h3>
                <p class="text-gray-600">Lancez un scan pour d√©couvrir les appareils sur votre r√©seau</p>
            </div>
        </div>
        
        <!-- TAB: VPN -->
        <div x-show="tab==='vpn'" x-cloak class="space-y-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">üîí VPN Tailscale</h2>
                <p class="text-sm text-gray-600">Gestion du r√©seau priv√© virtuel</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                <div class="text-6xl mb-4">üöß</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Module en d√©veloppement</h3>
                <p class="text-gray-600">Configuration Tailscale VPN √† venir</p>
            </div>
        </div>
        
    </main>
    
    <!-- Modal: Add Device -->
    <div x-show="showAddModal" x-cloak @click.self="showAddModal=false" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-md w-full" @click.stop>
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">‚ûï Ajouter un appareil</h3>
                <button @click="showAddModal=false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse IP *</label>
                    <input x-model="newDevice.ip" type="text" placeholder="192.168.1.100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom (optionnel)</label>
                    <input x-model="newDevice.name" type="text" placeholder="Mon appareil" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">MAC (optionnel)</label>
                    <input x-model="newDevice.mac" type="text" placeholder="00:11:22:33:44:55" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex gap-3">
                <button @click="showAddModal=false" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all font-medium">
                    Annuler
                </button>
                <button @click="addDeviceManual()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-medium">
                    ‚úÖ Ajouter
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: History -->
    <div x-show="showHistoryModal" x-cloak @click.self="showHistoryModal=false" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto" @click.stop>
            <div class="p-6 border-b border-gray-200 flex justify-between items-start">
                <div>
                    <h3 class="text-xl font-bold text-gray-900" x-text="'Historique: '+(selectedDevice?.name||selectedDevice?.ip)"></h3>
                    <p class="text-sm text-gray-600" x-text="selectedDevice?.mac"></p>
                </div>
                <button @click="showHistoryModal=false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6">
                <p class="text-gray-600 text-center py-8">Historique d√©taill√© en d√©veloppement<br>(API: <code>/api/network/v2/devices/{mac}/history</code>)</p>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div x-show="toast.show" x-cloak class="fixed bottom-4 right-4 z-50 animate-fade-in">
        <div :class="toast.type==='success'?'bg-green-600':toast.type==='error'?'bg-red-600':'bg-blue-600'" class="rounded-lg shadow-lg p-4 text-white max-w-sm">
            <p class="font-medium" x-text="toast.message"></p>
        </div>
    </div>
    
    <script>
    function app(){return{
        tab:'dashboard',
        loading:false,
        scanning:false,
        scanType:'',
        showAddModal:false,
        showHistoryModal:false,
        selectedDevice:null,
        lastUpdate:'',
        toast:{show:false,message:'',type:'success'},
        tabs:[
            {id:'dashboard',name:'Dashboard',icon:'üìä'},
            {id:'managed',name:'Appareils',icon:'üì±'},
            {id:'network',name:'R√©seau',icon:'üåê'},
            {id:'vpn',name:'VPN',icon:'üîí'}
        ],
        stats:{total:0,online:0,offline:0,managed:0},
        devices:[],
        scanResults:[],
        lastScanTime:null,
        showScanPanel:false,
        newDevice:{ip:'',name:'',mac:''},
        
        managedDevices(){return this.devices.filter(d=>d.managed===true||d.in_devices===true)},
        
        async init(){
            console.log('üöÄ 333HOME v7.0 PRO - Unified');
            await this.refreshAll();
            await this.loadRegistryDevices(); // ‚úÖ Charger registry (source unifi√©e)
            
            // ‚úÖ Interval 30s : Refresh registry (ARP + VPN status)
            setInterval(async ()=>{
                if(this.tab==='dashboard'){
                    await this.loadStats();
                }
                if(this.tab==='managed'){
                    await this.loadDevices();
                }
                if(this.tab==='network'){
                    // ‚úÖ Refresh registry status puis recharger
                    await this.refreshRegistryStatus();
                    await this.loadRegistryDevices();
                }
            },30000);
        },
        
        async refreshAll(){
            await Promise.all([this.loadStats(),this.loadDevices()]);
            this.lastUpdate=new Date().toLocaleTimeString('fr-FR');
        },
        
        async loadRegistryDevices(){
            // ‚úÖ Charger devices depuis NetworkRegistry (source unifi√©e + enrichie)
            try{
                const r=await fetch('/api/network/registry/');
                if(!r.ok)return;
                const d=await r.json();
                
                if(d.devices && Array.isArray(d.devices)){
                    // Mapper les devices du registry vers le format UI
                    this.scanResults = d.devices.map(device => ({
                        // IDs
                        mac: device.mac,
                        current_ip: device.current_ip || device.ip,  // ‚úÖ API retourne current_ip
                        ip: device.current_ip || device.ip,
                        
                        // Noms
                        current_hostname: device.current_hostname || device.hostname,
                        hostname: device.current_hostname || device.hostname,
                        name: device.current_hostname || device.hostname,
                        
                        // Infos enrichies
                        vendor: device.vendor || 'Unknown',
                        os_detected: device.os_detected || null,
                        device_type: device.device_type || null,
                        
                        // Status online
                        currently_online: device.is_online,
                        is_online: device.is_online,
                        
                        // VPN (depuis enrichissement Tailscale) - ‚úÖ Utiliser is_vpn_connected de l'API
                        vpn_ip: device.vpn_ip || null,
                        is_vpn_connected: device.is_vpn_connected || false,  // ‚úÖ Pas juste !!vpn_ip
                        
                        // Metadata
                        in_devices: device.is_managed || false,  // ‚úÖ API retourne is_managed
                        services: device.services || [],
                        last_seen: device.last_seen,
                        first_seen: device.first_seen,
                    }));
                    
                    this.scanType = 'REGISTRY';
                    this.lastScanTime = new Date().toLocaleTimeString('fr-FR');
                    console.log(`üì° Registry charg√©: ${this.scanResults.length} devices (vendor enrichi)`);
                }
            }catch(e){
                console.error('LoadRegistry:',e);
            }
        },
        
        async refreshRegistryStatus(){
            // ‚úÖ Refresh l√©ger registry (ARP + VPN status uniquement)
            try{
                const r=await fetch('/api/network/registry/refresh',{method:'POST'});
                if(!r.ok){
                    console.warn('Registry refresh failed:',r.status);
                    return;
                }
                const d=await r.json();
                console.log(`üîÑ Registry refreshed: ${d.online_count} online, ${d.vpn_count} VPN, ${d.updated_count} changes`);
            }catch(e){
                console.error('RefreshRegistry:',e);
            }
        },
        
        async loadLastScan(){
            // Legacy: garder pour compatibilit√© mais utiliser loadRegistryDevices() √† la place
            await this.loadRegistryDevices();
        },
        
        async loadStats(){
            try{
                const r=await fetch('/api/hub/stats');
                if(!r.ok)throw new Error('Stats API error');
                const d=await r.json();
                this.stats=d.devices||this.stats;
            }catch(e){console.error('Stats:',e)}
        },
        
        async loadDevices(){
            this.loading=true;
            try{
                const r=await fetch('/api/hub/devices');
                if(!r.ok)throw new Error('Devices API error');
                const d=await r.json();
                this.devices=Array.isArray(d)?d:(d.devices||[]);
                console.log('üì± Devices loaded:',this.devices.length,'(managed:'+this.managedDevices().length+')');
            }catch(e){console.error('Devices:',e);this.devices=[]}
            finally{this.loading=false}
        },
        
        async startScan(type){
            this.scanning=true;
            this.scanType=type.toUpperCase();
            this.scanResults=[];
            try{
                const payload={
                    scan_type:type,
                    subnet:"192.168.1.0/24",
                    timeout_ms:type==='full'?5000:2000,
                    scan_ports:type==='full',
                    port_preset:"quick"
                };
                console.log('üåê Starting scan:',payload);
                const r=await fetch('/api/network/scan',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(payload)
                });
                if(!r.ok){
                    const err=await r.json().catch(()=>({}));
                    throw new Error(err.detail||r.statusText);
                }
                const result=await r.json();
                console.log('‚úÖ Scan result:',result);
                
                // ‚úÖ Recharger depuis registry (avec vendor enrichi)
                await this.loadRegistryDevices();
                await this.loadDevices();
                await this.loadStats();
                
                this.showToast(`Scan ${type} termin√©: ${this.scanResults.length} appareil(s) d√©tect√©(s)`,'success');
            }catch(e){
                console.error('Scan error:',e);
                this.showToast('Erreur scan: '+e.message,'error');
            }finally{
                this.scanning=false;
            }
        },
        
        async addDeviceManual(){
            if(!this.newDevice.ip){
                this.showToast('IP obligatoire','error');
                return;
            }
            try{
                const payload={
                    ip:this.newDevice.ip,
                    managed:true
                };
                if(this.newDevice.name)payload.name=this.newDevice.name;
                if(this.newDevice.mac)payload.mac=this.newDevice.mac;
                
                const r=await fetch('/api/devices',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(payload)
                });
                if(!r.ok)throw new Error('Failed to add device');
                await this.loadDevices();
                await this.loadStats();
                this.showToast('Appareil ajout√©','success');
                this.showAddModal=false;
                this.newDevice={ip:'',name:'',mac:''};
            }catch(e){
                console.error('Add device error:',e);
                this.showToast('Erreur: '+e.message,'error');
            }
        },
        
        async addDeviceToManaged(device){
            try{
                const payload={
                    ip:device.current_ip||device.ip,
                    managed:true,
                    name:device.current_hostname||device.hostname||'',
                    mac:device.mac||'',
                    type:device.device_type||device.type||'',
                    manufacturer:device.vendor||device.manufacturer||''
                };
                console.log('‚ûï Adding device:',payload);
                const r=await fetch('/api/devices',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(payload)
                });
                if(!r.ok)throw new Error('Failed to add device');
                device.in_devices=true;
                await this.loadDevices();
                await this.loadStats();
                this.showToast('Appareil ajout√© √† la gestion','success');
            }catch(e){
                console.error('Add device error:',e);
                this.showToast('Erreur: '+e.message,'error');
            }
        },
        
        async removeDevice(device){
            if(!confirm(`Retirer ${device.name||device.ip} de la gestion?`))return;
            try{
                const r=await fetch(`/api/devices/${device.ip}`,{method:'DELETE'});
                if(!r.ok)throw new Error('Failed to remove device');
                await this.loadDevices();
                await this.loadStats();
                this.showToast('Appareil retir√©','success');
            }catch(e){
                console.error('Remove device error:',e);
                this.showToast('Erreur: '+e.message,'error');
            }
        },
        
        async wakeDevice(device){
            if(!device.mac){
                this.showToast('MAC address manquante','error');
                return;
            }
            try{
                const r=await fetch(`/api/devices/wake/${device.ip}`,{method:'POST'});
                if(!r.ok)throw new Error('Wake-on-LAN failed');
                this.showToast(`Wake-on-LAN envoy√© √† ${device.name||device.ip}`,'success');
                setTimeout(()=>this.loadDevices(),5000);
            }catch(e){
                console.error('Wake error:',e);
                this.showToast('Erreur: '+e.message,'error');
            }
        },
        
        viewHistory(device){
            this.selectedDevice=device;
            this.showHistoryModal=true;
        },
        
        async exportAllData(){
            try{
                const data={
                    timestamp:new Date().toISOString(),
                    stats:this.stats,
                    devices:this.devices,
                    scanResults:this.scanResults
                };
                const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
                const url=URL.createObjectURL(blob);
                const a=document.createElement('a');
                a.href=url;
                a.download=`333home_backup_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('Export r√©ussi','success');
            }catch(e){
                console.error('Export error:',e);
                this.showToast('Erreur export: '+e.message,'error');
            }
        },
        
        getDeviceTitle(d){
            const hostname=d.current_hostname||d.hostname||d.name;
            if(hostname && hostname.trim() && !hostname.includes('192.168') && !hostname.includes('N/A')){
                return hostname.replace('.local','');
            }
            const vendor=d.vendor||d.manufacturer;
            if(vendor && vendor!=='Unknown' && vendor.trim()){
                const ip=d.current_ip||d.ip;
                return`${vendor} ‚Ä¢ ${ip}`;
            }
            const type=d.device_type||d.type;
            if(type && type.trim() && !type.startsWith('‚ùì') && !type.includes('Unknown')){
                const ip=d.current_ip||d.ip;
                return`${type} ‚Ä¢ ${ip}`;
            }
            return d.current_ip||d.ip||d.mac||'Device inconnu';
        },
        
        formatTime(timestamp){
            if(!timestamp)return'N/A';
            try{
                const date=new Date(timestamp);
                return date.toLocaleString('fr-FR',{dateStyle:'short',timeStyle:'short'});
            }catch{return timestamp}
        },
        
        showToast(msg,type='success'){
            this.toast={show:true,message:msg,type};
            setTimeout(()=>this.toast.show=false,4000);
        }
    }}
    </script>
</body>
</html>
